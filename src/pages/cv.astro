---
import BaseLayout from '../layouts/BaseLayout.astro';
import timeline from '../content/timeline.json';

const base = import.meta.env.BASE_URL || '/';
const currentIndex = timeline.findIndex((item) => item.current);
---

<BaseLayout
  title="Burak Yuksel - CV"
  description="CV timeline with milestones and quick links."
  hideHeader={true}
  footerText="ЖИ 2026 Burak Yuksel"
>
  <div class="cv-page">
    <nav class="cv-nav">
      <div class="nav-links">
        <a href={base}>Homepage</a>
        <a href={`${base}blog/`}>Blog</a>
        <a href="https://github.com/BYuksel96" target="_blank" rel="noreferrer">GitHub</a>
      </div>
      <div class="nav-line"></div>
    </nav>

    <section class="timeline" data-current-index={currentIndex}>
      <div class="spine solid"></div>
      <div class="spine dotted"></div>

      <div class="timeline-items">
        {timeline.map((item, index) => (
          <div
            class={`timeline-row ${item.side === 'left' ? 'left' : 'right'}`}
            data-current={item.current ? 'true' : 'false'}
            data-index={index}
          >
            <div class="branch"></div>
            <button
              class="card"
              data-id={item.id}
              data-title={item.title}
              data-date={item.date}
              data-description={item.description}
              data-image={item.imageSrc}
              aria-label={`Open ${item.title}`}
            >
              <div class="card-inner">
                <div class="face front" style={`background-image:url('${item.imageSrc}')`}></div>
                <div class="face back">
                  <div class="label">{item.title}</div>
                  <div class="muted small">{item.date}</div>
                </div>
              </div>
            </button>
          </div>
        ))}
      </div>
    </section>

    <div class="floating-icons">
      <a class="icon-card" href={`${base}cv.pdf`} download>
        <div class="icon-flip">
          <div class="icon-face icon-front">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.6">
              <path d="M12 3v12" />
              <path d="M7 11l5 5 5-5" />
              <path d="M5 19h14" />
            </svg>
          </div>
          <div class="icon-face icon-back">Download CV</div>
        </div>
      </a>
      <a class="icon-card" href="https://linkedin.com" target="_blank" rel="noreferrer">
        <div class="icon-flip">
          <div class="icon-face icon-front">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
              <path d="M4.98 3.5C4.98 4.88 3.88 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1 4.98 2.12 4.98 3.5zM.2 8.1h4.6V24H.2zM8.4 8.1h4.4v2.2h.06c.62-1.2 2.14-2.47 4.42-2.47 4.73 0 5.6 3.11 5.6 7.15V24h-4.6v-7.42c0-1.77-.03-4.05-2.47-4.05-2.47 0-2.85 1.93-2.85 3.92V24H8.4z" />
            </svg>
          </div>
          <div class="icon-face icon-back">LinkedIn</div>
        </div>
      </a>
    </div>

    <div class="modal-backdrop" aria-hidden="true">
      <div class="modal">
        <header class="modal-head">
          <div class="modal-title">
            <h3 id="modalTitle"></h3>
            <span class="muted" id="modalDate"></span>
          </div>
          <button class="modal-close" aria-label="Close modal">✕</button>
        </header>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
  <script>
    if (typeof window !== 'undefined') {
      window.addEventListener('DOMContentLoaded', () => {
        const timelineEl = document.querySelector('.timeline');
        const solid = document.querySelector('.spine.solid');
        const dotted = document.querySelector('.spine.dotted');
        const current = document.querySelector('.timeline-row[data-current="true"]');
        const items = document.querySelectorAll('.timeline-row');
        const modalBackdrop = document.querySelector('.modal-backdrop');
        const modal = document.querySelector('.modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalDate = document.getElementById('modalDate');
        const modalBody = document.getElementById('modalBody');
        const closeBtn = document.querySelector('.modal-close');
        const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        const layoutSpine = () => {
          if (!timelineEl || !solid || !dotted || !current) return;
          const tRect = timelineEl.getBoundingClientRect();
          const cRect = current.getBoundingClientRect();
          const target = cRect.top + cRect.height / 2 - tRect.top;
          solid.style.height = '0px';
          dotted.style.height = '0px';
          dotted.style.top = `${target}px`;
          dotted.style.opacity = '0';

          const solidDuration = prefersReduce ? 0 : 1;
          const dottedDuration = prefersReduce ? 0 : 0.8;
          const dottedDelay = prefersReduce ? 0 : 0.2;

          gsap.to(solid, { height: target, duration: solidDuration, ease: 'power2.out' });
          gsap.to(dotted, { height: Math.max(tRect.height - target, 0), duration: dottedDuration, delay: dottedDelay, ease: 'power2.out', opacity: 1 });
        };

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add('visible');
              }
            });
          },
          { threshold: 0.2 }
        );

        items.forEach((row) => observer.observe(row));

        const openModal = (card) => {
          if (!modal || !modalBackdrop || !modalTitle || !modalDate || !modalBody) return;
          modalTitle.textContent = card.dataset.title || '';
          modalDate.textContent = card.dataset.date || '';
          modalBody.textContent = card.dataset.description || '';
          modalBackdrop.classList.add('active');
          gsap.fromTo(
            modal,
            { opacity: 0, scale: 0.9, rotateY: -10 },
            { opacity: 1, scale: 1, rotateY: 0, duration: prefersReduce ? 0 : 0.6, ease: 'power2.out' }
          );
          gsap.to(card.querySelector('.card-inner'), { rotateY: 180, duration: prefersReduce ? 0 : 0.5, ease: 'power2.out' });
        };

        const closeModal = () => {
          if (!modal || !modalBackdrop) return;
          modalBackdrop.classList.remove('active');
          gsap.to(modal, { opacity: 0, scale: 0.95, duration: prefersReduce ? 0 : 0.25 });
          document.querySelectorAll('.card-inner').forEach((inner) => {
            gsap.set(inner, { rotateY: 0 });
          });
        };

        document.addEventListener('click', (event) => {
          const card = (event.target instanceof Element && event.target.closest('.card')) || null;
          if (card) {
            event.preventDefault();
            openModal(card);
          }
          if (event.target instanceof Element && event.target.classList.contains('modal-backdrop')) {
            closeModal();
          }
        });

        closeBtn?.addEventListener('click', closeModal);
        modalBackdrop?.addEventListener('click', (e) => {
          if (e.target === modalBackdrop) closeModal();
        });

        layoutSpine();
        window.addEventListener('resize', () => {
          layoutSpine();
        });
      });
    }
  </script>

  <style>
    .cv-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 48px;
      padding-top: 36px;
    }
    .cv-nav {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .nav-links {
      display: flex;
      gap: 28px;
      font-weight: 600;
    }
    .nav-links a {
      color: var(--text);
      text-decoration: none;
    }
    .nav-links a:hover {
      opacity: 0.8;
    }
    .nav-line {
      width: min(960px, 90vw);
      height: 1px;
      background: rgba(255, 255, 255, 0.25);
    }
    .timeline {
      position: relative;
      width: min(980px, 92vw);
      margin: 0 auto;
      padding: 20px 0 120px;
    }
    .spine {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      border-radius: 999px;
    }
    .spine.solid {
      background: var(--text);
      height: 0;
    }
    .spine.dotted {
      background: repeating-linear-gradient(180deg, rgba(255, 255, 255, 0.5) 0 10px, transparent 10px 18px);
      opacity: 0;
    }
    .spine-dot {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--text);
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.25);
    }
    .timeline-items {
      display: flex;
      flex-direction: column;
      gap: 110px;
      position: relative;
      z-index: 1;
    }
    .timeline-row {
      position: relative;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      align-items: center;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .timeline-row.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .timeline-row.left .branch {
      grid-column: 1 / 2;
      justify-self: end;
    }
    .timeline-row.left .card {
      grid-column: 1 / 2;
      justify-self: start;
    }
    .timeline-row.right .branch {
      grid-column: 2 / 3;
      justify-self: start;
    }
    .timeline-row.right .card {
      grid-column: 2 / 3;
      justify-self: end;
    }
    .branch {
      width: 120px;
      height: 2px;
      background: rgba(255, 255, 255, 0.35);
      position: relative;
    }
    .branch::after {
      content: '';
      position: absolute;
      top: 50%;
      right: -7px;
      transform: translateY(-50%);
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--bg);
      border: 2px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.35);
    }
    .timeline-row:first-of-type .branch::after {
      background: white;
      border: 2px solid rgba(255, 255, 255, 1);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.35);
    }
    .timeline-row.right .branch::after {
      right: auto;
      left: -7px;
    }
    .card {
      width: 220px;
      height: 220px;
      background: transparent;
      border: none;
      padding: 0;
      cursor: pointer;
      perspective: 1200px;
      box-shadow: none;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      overflow: hidden;
      transform-style: preserve-3d;
      transition: transform 0.4s ease;
      box-shadow: 0 10px 80px rgba(0, 0, 0, 0.5);
    }
    .card .face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      display: grid;
      place-items: center;
      color: var(--text);
    }
    .card .front {
      background-size: cover;
      background-position: center;
      filter: grayscale(0.1);
    }
    .card .back {
      background: rgba(0, 0, 0, 0.4);
      transform: rotateY(180deg);
      padding: 16px;
      text-align: center;
    }
    .label {
      font-weight: 800;
      letter-spacing: 0.5px;
    }
    .small {
      font-size: 0.9rem;
    }

    .floating-icons {
      position: fixed;
      bottom: 28px;
      left: 28px;
      display: grid;
      gap: 12px;
      z-index: 8;
    }
    .icon-card {
      width: 68px;
      height: 68px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      display: grid;
      place-items: center;
      text-decoration: none;
      color: var(--text);
      overflow: hidden;
      perspective: 800px;
    }
    .icon-flip {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.45s ease;
    }
    .icon-card:hover .icon-flip,
    .icon-card:focus-visible .icon-flip {
      transform: rotateY(180deg);
    }
    .icon-face {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      backface-visibility: hidden;
      padding: 8px;
      text-align: center;
      font-weight: 700;
      font-size: 0.85rem;
      background: rgba(0, 0, 0, 0.35);
    }
    .icon-front {
      background: transparent;
    }
    .icon-back {
      transform: rotateY(180deg);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12;
      padding: 16px;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal {
      width: min(900px, 60vw);
      max-width: 960px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 18px;
      box-shadow: 0 32px 70px rgba(0, 0, 0, 0.5);
      color: var(--text);
      display: flex;
      flex-direction: column;
      max-height: 80vh;
      backdrop-filter: blur(4px);
    }
    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .modal-title h3 {
      margin: 0;
    }
    .modal-close {
      background: transparent;
      border: 2px solid #f87171;
      color: #f87171;
      border-radius: 10px;
      width: 40px;
      height: 40px;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .modal-body {
      padding: 18px;
      overflow-y: auto;
      line-height: 1.6;
    }

    @media (max-width: 960px) {
      .timeline-row {
        grid-template-columns: 1fr;
        justify-items: center;
      }
      .timeline-row.left .branch,
      .timeline-row.right .branch {
        order: -1;
        justify-self: center;
        transform: rotate(90deg);
        width: 80px;
      }
      .branch::after {
        display: none;
      }
      .timeline-row.left .card,
      .timeline-row.right .card {
        justify-self: center;
      }
      .spine {
        left: 50%;
      }
    }
  </style>
</BaseLayout>
